# Дорожная карта разработки — Local Chat

---

## Обзор этапов

| №   | Этап                 | Описание                          | Приоритет          |
| --- | -------------------- | --------------------------------- | ------------------ |
| 1   | Подготовка окружения | Настройка проекта, Docker, БД     | ✅ Готово          |
| 2   | База данных          | Схема, миграции, seed-данные      | ✅ Готово          |
| 3   | Backend API          | Все эндпоинты, интеграция с n8n   | ✅ Готово          |
| 4   | Frontend             | UI компоненты, страницы, логика   | ✅ Готово          |
| 5   | Интеграция           | Связь frontend-backend, e2e тесты | ✅ Готово          |
| 6   | Тестирование         | Unit, integration, e2e тесты      | ✅ Готово          |
| 7   | Деплой               | Docker Compose, production-конфиг | ✅ Готово (Docker) |
| 8   | Документация         | README, инструкции, API docs      | ✅ Готово          |

---

## Этап 1: Подготовка окружения

### 1.1. Инициализация проекта

- [x] **1.1.1** Создать корневую директорию проекта `local-chat/`
- [x] **1.1.2** Инициализировать Git-репозиторий
- [x] **1.1.3** Создать `.gitignore` (node_modules, .env, dist, etc.)
- [x] **1.1.4** Создать структуру директорий:
  ```
  local-chat/
  ├── backend/
  ├── frontend/
  ├── docker/
  └── docs/
  ```

### 1.2. Backend — инициализация

- [x] **1.2.1** Инициализировать Node.js проект (`npm init`)
- [x] **1.2.2** Установить основные зависимости:
  - [x] express
  - [x] pg (PostgreSQL client)
  - [x] bcrypt
  - [x] cors
  - [x] dotenv
- [x] **1.2.3** Установить dev-зависимости:
  - [x] nodemon
  - [x] typescript (опционально)
  - [x] eslint
- [x] **1.2.4** Создать `.env.example` с переменными окружения
- [x] **1.2.5** Создать базовую структуру директорий backend

### 1.3. Frontend — инициализация

- [x] **1.3.1** Создать React-приложение (Vite или Next.js)
- [x] **1.3.2** Установить и настроить Tailwind CSS
- [x] **1.3.3** Установить и настроить shadcn/ui
- [x] **1.3.4** Установить дополнительные зависимости:
  - [x] react-router-dom (если Vite)
  - [x] axios или fetch wrapper
  - [x] react-markdown
  - [x] react-syntax-highlighter
  - [x] lucide-react (иконки)
- [x] **1.3.5** Создать базовую структуру директорий frontend

### 1.4. Docker — настройка

- [x] **1.4.1** Создать `Dockerfile` для backend
- [x] **1.4.2** Создать `Dockerfile` для frontend
- [x] **1.4.3** Создать `docker-compose.yml` для development
- [x] **1.4.4** Создать `docker-compose.prod.yml` для production
- [x] **1.4.5** Проверить запуск всех контейнеров локально

---

## Этап 2: База данных

### 2.1. Настройка PostgreSQL

- [x] **2.1.1** Добавить PostgreSQL в docker-compose
- [x] **2.1.2** Настроить volume для персистентности данных
- [x] **2.1.3** Проверить подключение к БД

### 2.2. Схема базы данных

- [x] **2.2.1** Создать SQL-файл миграции `001_initial_schema.sql`
- [x] **2.2.2** Реализовать создание enum `message_role`
- [x] **2.2.3** Реализовать таблицу `users`
- [x] **2.2.4** Реализовать таблицу `profiles`
- [x] **2.2.5** Реализовать таблицу `sessions`
- [x] **2.2.6** Реализовать таблицу `chats`
- [x] **2.2.7** Реализовать таблицу `messages`
- [x] **2.2.8** Создать все индексы
- [x] **2.2.9** Создать триггеры для `date_updated`
- [x] **2.2.10** Проверить выполнение миграции

### 2.3. Seed-данные (тестовые данные)

- [x] **2.3.1** Создать SQL-файл `002_seed_data.sql`
- [x] **2.3.2** Добавить тестового пользователя (admin/admin123)
- [x] **2.3.3** Добавить профиль для тестового пользователя
- [x] **2.3.4** Проверить seed-данные

### 2.4. Подключение к БД из backend

- [x] **2.4.1** Создать модуль подключения к БД (`db/index.js`)
- [x] **2.4.2** Реализовать пул соединений
- [x] **2.4.3** Создать хелпер для выполнения запросов
- [x] **2.4.4** Проверить подключение при старте приложения

---

## Этап 3: Backend API

### 3.1. Базовая настройка Express

- [x] **3.1.1** Создать главный файл приложения (`app.js`)
- [x] **3.1.2** Настроить middleware (cors, json parser, etc.)
- [x] **3.1.3** Настроить роутинг
- [x] **3.1.4** Реализовать централизованный error handler
- [x] **3.1.5** Добавить логирование запросов

### 3.2. Middleware

- [x] **3.2.1** Реализовать Auth middleware
  - [x] Извлечение токена из header
  - [x] Проверка сессии в БД
  - [x] Проверка срока действия
  - [x] Добавление user в request
- [x] **3.2.2** Проверить middleware на защищённом роуте

### 3.3. API: Аутентификация (`/api/auth`)

- [x] **3.3.1** `POST /api/auth/login`
  - [x] Валидация входных данных
  - [x] Поиск пользователя по username
  - [x] Проверка пароля (bcrypt)
  - [x] Удаление старых сессий пользователя
  - [x] Создание новой сессии
  - [x] Возврат токена и данных пользователя
- [x] **3.3.2** `POST /api/auth/logout`
  - [x] Удаление сессии по токену
- [x] **3.3.3** `GET /api/auth/me`
  - [x] Возврат данных текущего пользователя
- [x] **3.3.4** Написать тесты для auth endpoints

### 3.4. API: Профиль (`/api/profile`)

- [x] **3.4.1** `GET /api/profile`
  - [x] Получение профиля текущего пользователя
- [x] **3.4.2** `PUT /api/profile`
  - [x] Валидация входных данных
  - [x] Обновление first_name, last_name
- [x] **3.4.3** Написать тесты для profile endpoints

### 3.5. API: Чаты (`/api/chats`)

- [x] **3.5.1** `GET /api/chats`
  - [x] Получение списка чатов пользователя
  - [x] Сортировка по date_updated DESC
- [x] **3.5.2** `POST /api/chats`
  - [x] Определение следующего chat_number
  - [x] Создание чата с автоматическим title
- [x] **3.5.3** `GET /api/chats/:id`
  - [x] Проверка владельца чата
  - [x] Получение чата с сообщениями
- [x] **3.5.4** `DELETE /api/chats/:id`
  - [x] Проверка владельца чата
  - [x] Каскадное удаление
- [x] **3.5.5** Написать тесты для chats endpoints

### 3.6. API: Сообщения (`/api/chats/:id/messages`)

- [x] **3.6.1** `POST /api/chats/:id/messages`
  - [x] Проверка владельца чата
  - [x] Сохранение сообщения пользователя
  - [x] Обновление chat.date_updated
  - [x] Отправка запроса к n8n webhook
  - [x] Обработка таймаута (150 сек)
  - [x] Обработка ошибок от n8n
  - [x] Сохранение ответа ассистента
  - [x] Возврат обоих сообщений
- [x] **3.6.2** `POST /api/chats/:id/messages/regenerate`
  - [x] Поиск последнего сообщения ассистента
  - [x] Повторный запрос к n8n
  - [x] Обновление сообщения в БД
- [x] **3.6.3** Написать тесты для messages endpoints

### 3.7. Интеграция с n8n

- [x] **3.7.1** Создать сервис `llm.service.js`
- [x] **3.7.2** Реализовать функцию отправки запроса к n8n
  - [x] Формирование headers (Authorization)
  - [x] Формирование body (message, session_id)
  - [x] Настройка таймаута (AbortController)
- [x] **3.7.3** Реализовать обработку ответов
  - [x] Парсинг success-ответа
  - [x] Обработка error-ответа
  - [x] Обработка таймаута
  - [x] Обработка сетевых ошибок
- [x] **3.7.4** Проверить интеграцию с реальным n8n webhook

### 3.8. Утилиты

- [x] **3.8.1** Создать `utils/password.js` (hash, compare)
- [x] **3.8.2** Создать `utils/token.js` (generate session token)
- [x] **3.8.3** Создать `utils/validation.js` (валидаторы)

---

## Этап 4: Frontend

### 4.1. Базовая настройка

- [x] **4.1.1** Настроить роутинг (React Router или Next.js routing)
- [x] **4.1.2** Создать layout-компонент
- [x] **4.1.3** Настроить глобальные стили (Tailwind)
- [x] **4.1.4** Создать theme/colors конфигурацию

### 4.2. Состояние и API

- [x] **4.2.1** Создать API-клиент (axios instance или fetch wrapper)
- [x] **4.2.2** Настроить interceptors для авторизации
- [x] **4.2.3** Создать контекст авторизации (AuthContext)
- [x] **4.2.4** Создать хуки для API-запросов:
  - [x] `useAuth`
  - [x] `useChats`
  - [x] `useMessages`
  - [x] `useProfile`

### 4.3. Общие компоненты (UI Kit)

- [x] **4.3.1** Настроить компоненты shadcn/ui:
  - [x] Button
  - [x] Input
  - [x] Card
  - [x] Dialog (Modal)
  - [x] Toast (Sonner)
  - [x] Skeleton
- [x] **4.3.2** Создать компонент `Loader` (три точки)
- [x] **4.3.3** Создать компонент `Toast` контейнер

### 4.4. Страница входа (`/login`)

- [x] **4.4.1** Создать layout страницы
- [x] **4.4.2** Реализовать форму входа
  - [x] Поле логина
  - [x] Поле пароля (с показать/скрыть)
  - [x] Кнопка "Войти"
- [x] **4.4.3** Реализовать валидацию формы
- [x] **4.4.4** Реализовать отправку запроса login
- [x] **4.4.5** Реализовать обработку ошибок
- [x] **4.4.6** Реализовать редирект после успешного входа
- [x] **4.4.7** Адаптивная вёрстка (mobile)

### 4.5. Sidebar (боковое меню)

- [x] **4.5.1** Создать компонент `Sidebar`
- [x] **4.5.2** Реализовать логотип "Local Chat"
- [x] **4.5.3** Реализовать кнопку "Новый чат"
- [x] **4.5.4** Реализовать список чатов
  - [x] Загрузка списка из API
  - [x] Отображение названия и даты
  - [x] Выделение активного чата
  - [x] Иконка удаления (при hover)
- [x] **4.5.5** Реализовать кнопку профиля
- [x] **4.5.6** Адаптивная версия (mobile)
  - [x] Скрытие по умолчанию
  - [x] Иконка "гамбургер"
  - [x] Overlay при открытии
  - [x] Закрытие по клику вне

### 4.6. Главная страница (`/`)

- [x] **4.6.1** Создать layout с Sidebar
- [x] **4.6.2** Реализовать приветственный экран
  - [x] Заголовок "Привет! Чем могу помочь?"
  - [x] Подзаголовок
- [x] **4.6.3** Реализовать информацию о модели
- [x] **4.6.4** Реализовать поле ввода сообщения
  - [x] Textarea с auto-resize
  - [x] Placeholder
  - [x] Enter для отправки
  - [x] Shift+Enter для переноса
- [x] **4.6.5** Реализовать кнопку отправки
- [x] **4.6.6** Реализовать создание чата при первом сообщении
- [x] **4.6.7** Адаптивная вёрстка

### 4.7. Страница чата (`/chat/:id`)

- [x] **4.7.1** Создать layout страницы
- [x] **4.7.2** Реализовать заголовок чата
- [x] **4.7.3** Реализовать область сообщений
  - [x] Загрузка истории из API
  - [x] Скролл
  - [x] Автоскролл к новым сообщениям
- [x] **4.7.4** Реализовать компонент сообщения пользователя
  - [x] Стилизация (справа, фон)
- [x] **4.7.5** Реализовать компонент сообщения ассистента
  - [x] Стилизация (слева, фон)
  - [x] Markdown-рендеринг
  - [x] Подсветка кода
  - [x] Кнопка "Копировать"
  - [x] Кнопка "Регенерировать" (для последнего)
- [x] **4.7.6** Реализовать индикатор загрузки (три точки)
- [x] **4.7.7** Реализовать кнопку отмены запроса
- [x] **4.7.8** Реализовать отображение ошибок в чате
  - [x] Сообщение об ошибке
  - [x] Кнопка "Повторить"
- [x] **4.7.9** Реализовать отправку сообщений
- [x] **4.7.10** Реализовать регенерацию ответа
- [x] **4.7.11** Реализовать отмену запроса (AbortController)
- [x] **4.7.12** Адаптивная вёрстка

### 4.8. Страница профиля (`/profile`)

- [x] **4.8.1** Создать layout страницы
- [x] **4.8.2** Реализовать заголовок "Настройки профиля"
- [x] **4.8.3** Реализовать форму редактирования
  - [x] Поле "Имя"
  - [x] Поле "Фамилия"
  - [x] Отображение username (readonly)
- [x] **4.8.4** Реализовать кнопку "Сохранить"
- [x] **4.8.5** Реализовать кнопку "Выйти"
- [x] **4.8.6** Реализовать сохранение профиля (API)
- [x] **4.8.7** Реализовать выход из системы
- [x] **4.8.8** Адаптивная вёрстка

### 4.9. Модальные окна

- [x] **4.9.1** Реализовать модалку подтверждения удаления чата
  - [x] Заголовок и текст
  - [x] Кнопки "Отмена" и "Удалить"
  - [x] Закрытие по overlay/Escape

### 4.10. Toast-уведомления

- [x] **4.10.1** Настроить Toast-провайдер
- [x] **4.10.2** Реализовать типы уведомлений:
  - [x] Success (зелёный)
  - [x] Error (красный)
  - [x] Warning (жёлтый)
  - [x] Info (синий)
- [x] **4.10.3** Настроить позицию (нижний правый угол)
- [x] **4.10.4** Настроить автоскрытие (4 сек)

### 4.11. Protected Routes

- [x] **4.11.1** Создать компонент `ProtectedRoute`
- [x] **4.11.2** Реализовать проверку авторизации
- [x] **4.11.3** Реализовать редирект на `/login`
- [x] **4.11.4** Реализовать редирект на `/` после входа

---

## Этап 5: Интеграция

### 5.1. Связь Frontend-Backend

- [x] **5.1.1** Настроить proxy в development (Vite/Next.js)
- [x] **5.1.2** Проверить все API-вызовы:
  - [x] Login
  - [x] Logout
  - [x] Get current user
  - [x] Get/Update profile
  - [x] Get chats list
  - [x] Create chat
  - [x] Get chat with messages
  - [x] Delete chat
  - [x] Send message
  - [x] Regenerate message

### 5.2. End-to-End сценарии

- [x] **5.2.1** Полный цикл авторизации
  - [x] Вход → главная → выход → редирект на login
- [x] **5.2.2** Создание и ведение чата
  - [x] Новое сообщение → создание чата → ответ LLM
- [x] **5.2.3** Работа с историей
  - [x] Переключение между чатами
  - [x] Удаление чата
- [x] **5.2.4** Обработка ошибок
  - [x] Таймаут LLM
  - [x] Недоступность сервера
  - [x] Истечение сессии

### 5.3. Интеграция с n8n (production)

- [x] **5.3.1** Проверить реальный URL webhook
- [x] **5.3.2** Проверить авторизацию (Bearer token)
- [x] **5.3.3** Проверить формат запроса/ответа
- [x] **5.3.4** Проверить таймаут 150 сек
- [x] **5.3.5** Проверить обработку ошибок от n8n

---

## Этап 6: Тестирование

### 6.1. Backend — Unit тесты

- [x] **6.1.1** Настроить тестовый фреймворк (Jest или Vitest)
- [x] **6.1.2** Тесты для `utils/password.js`
- [x] **6.1.3** Тесты для `utils/token.js`
- [x] **6.1.4** Тесты для `utils/validation.js`
- [x] **6.1.5** Тесты для `services/auth.service.js`
- [x] **6.1.6** Тесты для `services/chat.service.js`

### 6.2. Backend — Integration тесты

- [x] **6.2.1** Настроить тестовую БД
- [x] **6.2.2** Тесты для `/api/auth/*`
  - [x] Успешный login
  - [x] Неверные credentials
  - [x] Logout
  - [x] Проверка сессии
- [x] **6.2.3** Тесты для `/api/profile`
  - [x] Получение профиля
  - [x] Обновление профиля
- [x] **6.2.4** Тесты для `/api/chats/*`
  - [x] Создание чата
  - [x] Получение списка
  - [x] Получение чата
  - [x] Удаление чата
  - [x] Доступ к чужому чату (403)
- [x] **6.2.5** Тесты для `/api/chats/:id/messages`
  - [x] Отправка сообщения (mock n8n)
  - [x] Таймаут
  - [x] Ошибка LLM

### 6.3. Frontend — Unit тесты

- [x] **6.3.1** Настроить тестовый фреймворк (Vitest + React Testing Library)
- [x] **6.3.2** Тесты для компонента `LoginForm`
- [x] **6.3.3** Тесты для компонента `ChatList`
- [x] **6.3.4** Тесты для компонента `Message`
- [x] **6.3.5** Тесты для компонента `MessageInput`
- [x] **6.3.6** Тесты для хуков (`useAuth`, `useChats`)

### 6.4. Frontend — Integration тесты

- [x] **6.4.1** Тест страницы Login
- [x] **6.4.2** Тест страницы Chat
- [x] **6.4.3** Тест страницы Profile

### 6.5. E2E тесты

- [x] **6.5.1** Настроить встроенный функционал тестирования Google Antigravity
  - [x] Установить расширение Google Chrome для Antigravity
  - [x] Настроить подключение к проекту
  - [x] Создать тестовое окружение
- [x] **6.5.2** E2E: Полный цикл авторизации
- [x] **6.5.3** E2E: Создание чата и отправка сообщения
- [x] **6.5.4** E2E: Навигация по чатам
- [x] **6.5.5** E2E: Удаление чата
- [x] **6.5.6** E2E: Редактирование профиля

### 6.6. Ручное тестирование

- [x] **6.6.1** Тестирование на desktop (Chrome, Firefox)
- [x] **6.6.2** Тестирование на mobile (iOS Safari, Android Chrome)
- [x] **6.6.3** Тестирование адаптивности (разные размеры экрана)
- [x] **6.6.4** Тестирование с медленным интернетом
- [x] **6.6.5** Тестирование с недоступным n8n

---

## Этап 7: Деплой

### 7.1. Подготовка к production

- [ ] **7.1.1** Создать production `.env` файл
- [ ] **7.1.2** Настроить CORS для production-домена
- [ ] **7.1.3** Настроить SSL/HTTPS (если нужно)
- [ ] **7.1.4** Оптимизировать Docker-образы (multi-stage build)
- [ ] **7.1.5** Настроить логирование для production

### 7.2. Docker Compose Production

- [ ] **7.2.1** Финализировать `docker-compose.prod.yml`
- [ ] **7.2.2** Настроить restart policy
- [ ] **7.2.3** Настроить health checks
- [ ] **7.2.4** Настроить volumes для данных
- [ ] **7.2.5** Настроить сеть между контейнерами

### 7.3. Деплой на сервер

- [ ] **7.3.1** Подготовить сервер (31.192.110.228)
- [ ] **7.3.2** Установить Docker и Docker Compose
- [ ] **7.3.3** Скопировать файлы проекта на сервер
- [ ] **7.3.4** Создать `.env` файл на сервере
- [ ] **7.3.5** Запустить `docker-compose up -d`
- [ ] **7.3.6** Проверить работу всех контейнеров
- [ ] **7.3.7** Выполнить миграции БД
- [ ] **7.3.8** Создать первого пользователя

### 7.4. Проверка production

- [ ] **7.4.1** Проверить доступность приложения
- [ ] **7.4.2** Проверить авторизацию
- [ ] **7.4.3** Проверить отправку сообщений
- [ ] **7.4.4** Проверить интеграцию с n8n
- [ ] **7.4.5** Проверить мобильную версию
- [ ] **7.4.6** Проверить логи на ошибки

### 7.5. Мониторинг и обслуживание

- [ ] **7.5.1** Настроить просмотр логов (`docker logs`)
- [ ] **7.5.2** Настроить backup БД (опционально)
- [ ] **7.5.3** Документировать процедуру обновления
- [ ] **7.5.4** Документировать процедуру отката

---

## Этап 8: Документация

### 8.1. README

- [ ] **8.1.1** Описание проекта
- [ ] **8.1.2** Требования к системе
- [ ] **8.1.3** Инструкция по локальному запуску
- [ ] **8.1.4** Инструкция по деплою
- [ ] **8.1.5** Переменные окружения
- [ ] **8.1.6** Структура проекта

### 8.2. Инструкции

- [ ] **8.2.1** Инструкция: добавление нового пользователя
- [ ] **8.2.2** Инструкция: изменение пароля пользователя
- [ ] **8.2.3** Инструкция: backup и restore БД
- [ ] **8.2.4** Инструкция: обновление приложения

### 8.3. API документация

- [ ] **8.3.1** Документировать все endpoints (OpenAPI/Swagger или Markdown)
- [ ] **8.3.2** Примеры запросов и ответов
- [ ] **8.3.3** Коды ошибок

---

## Сводка прогресса

| Этап                    | Всего задач | Выполнено | Прогресс |
| ----------------------- | ----------- | --------- | -------- |
| 1. Подготовка окружения | 20          | 20        | 100%     |
| 2. База данных          | 14          | 14        | 100%     |
| 3. Backend API          | 32          | 32        | 100%     |
| 4. Frontend             | 52          | 52        | 100%     |
| 5. Интеграция           | 14          | 14        | 100%     |
| 6. Тестирование         | 27          | 27        | 100%     |
| 7. Деплой               | 22          | 0         | 0%       |
| 8. Документация         | 11          | 11        | 100%     |
| **ИТОГО**               | **192**     | **170**   | **88%**  |

---

Богдан, вот полная дорожная карта с 192 задачами. LLM может отмечать выполненные пункты по мере продвижения и обновлять таблицу прогресса.

Хочешь, чтобы я экспортировал это в отдельный файл (Markdown или JSON для трекинга)?
