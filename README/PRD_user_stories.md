# ТЗ: Пользовательские истории — LocalChat (веб-интерфейс для локальной LLM)

---

## 1. Общая информация о проекте

| Параметр | Значение |
|----------|----------|
| Название проекта | LocalChat |
| Целевая аудитория | 2-10 пользователей (семья и друзья разработчика) |
| Платформа | Веб-приложение (адаптивное: desktop + mobile) |
| Бэкенд интеграция | n8n webhook + Ollama (qwen3:30b) |
| БД | Локальная (в контейнере приложения) |
| Аутентификация | Basic Auth (учётные записи создаёт разработчик) |

---

## 2. Роли пользователей

| Роль | Описание |
|------|----------|
| **Пользователь** | Зарегистрированный пользователь системы. Может вести диалоги с LLM, управлять своими чатами, редактировать профиль |
| **Разработчик** | Администратор системы. Создаёт учётные записи напрямую в БД. Не является ролью в интерфейсе |

---

## 3. Эпики

| ID | Эпик | Описание |
|----|------|----------|
| E1 | Аутентификация | Вход, выход, управление сессией |
| E2 | Чат с LLM | Создание чатов, отправка сообщений, получение ответов |
| E3 | История чатов | Просмотр, навигация, удаление чатов |
| E4 | Профиль пользователя | Просмотр и редактирование личных данных |
| E5 | Обработка ошибок и очереди | Уведомления об ошибках, очередь запросов, таймауты |

---

## 4. Пользовательские истории

### Эпик E1: Аутентификация

---

#### US-1.1: Вход в систему

**Как** пользователь,  
**я хочу** ввести логин и пароль на странице входа,  
**чтобы** получить доступ к своим чатам с нейросетью.

**Критерии приёмки:**
- [ ] Отображается форма с полями "Логин" и "Пароль"
- [ ] Поле пароля маскирует ввод
- [ ] При корректных данных — редирект на главную страницу
- [ ] При некорректных данных — сообщение об ошибке "Неверный логин или пароль"
- [ ] Кнопка "Войти" неактивна, пока оба поля не заполнены
- [ ] Форма адаптивна для мобильных устройств

**Технические заметки:**
- Сессия живёт 24 часа
- Одновременно активна только одна сессия на пользователя
- При входе с другого устройства — предыдущая сессия инвалидируется

---

#### US-1.2: Выход из системы

**Как** пользователь,  
**я хочу** нажать кнопку "Выйти" в настройках профиля,  
**чтобы** завершить сессию и защитить свой аккаунт.

**Критерии приёмки:**
- [ ] Кнопка "Выйти" находится в модальном окне/секции настроек профиля
- [ ] После нажатия — редирект на страницу входа
- [ ] Сессия полностью инвалидируется
- [ ] При попытке перейти на защищённые страницы — редирект на логин

---

#### US-1.3: Автоматический выход по истечении сессии

**Как** пользователь,  
**я хочу** быть автоматически разлогинен через 24 часа,  
**чтобы** обеспечить безопасность аккаунта.

**Критерии приёмки:**
- [ ] Через 24 часа после входа сессия истекает
- [ ] При следующем действии — редирект на страницу входа
- [ ] Отображается сообщение "Сессия истекла. Пожалуйста, войдите снова"

---

### Эпик E2: Чат с LLM

---

#### US-2.1: Просмотр главной страницы (новый чат)

**Как** пользователь,  
**я хочу** видеть приветственный экран с полем ввода сообщения,  
**чтобы** сразу начать диалог с нейросетью.

**Критерии приёмки:**
- [ ] Центрированное поле ввода сообщения
- [ ] Отображается название подключённой модели (qwen3:30b) — только для информации, без возможности выбора
- [ ] Placeholder в поле ввода: "Напишите сообщение..."
- [ ] Кнопка отправки (иконка) справа от поля ввода
- [ ] Боковое меню с историей чатов слева

---

#### US-2.2: Создание нового чата через кнопку

**Как** пользователь,  
**я хочу** нажать кнопку "Новый чат" в боковом меню,  
**чтобы** начать новый диалог, не теряя предыдущие.

**Критерии приёмки:**
- [ ] Кнопка "Новый чат" расположена вверху бокового меню
- [ ] При нажатии — переход на главную страницу с пустым полем ввода
- [ ] Текущий чат сохраняется в истории (если в нём есть сообщения)

---

#### US-2.3: Автоматическое создание чата при первом сообщении

**Как** пользователь,  
**я хочу** отправить сообщение с главной страницы,  
**чтобы** новый чат создался автоматически.

**Критерии приёмки:**
- [ ] После отправки первого сообщения создаётся новый чат
- [ ] Чат получает название "Чат №{порядковый_номер}" (глобально для пользователя)
- [ ] Чат появляется в списке истории в боковом меню
- [ ] URL меняется на /chat/{chat_id}

---

#### US-2.4: Отправка сообщения в существующий чат

**Как** пользователь,  
**я хочу** написать сообщение и нажать кнопку отправки,  
**чтобы** получить ответ от нейросети.

**Критерии приёмки:**
- [ ] Сообщение можно отправить кнопкой или клавишей Enter
- [ ] Shift+Enter — перенос строки (без отправки)
- [ ] После отправки поле ввода очищается
- [ ] Моё сообщение появляется в окне чата справа
- [ ] Отображается индикатор загрузки (анимация "нейросеть думает...")
- [ ] Кнопка отправки блокируется до получения ответа
- [ ] Отображается кнопка "Отмена" во время ожидания ответа

---

#### US-2.5: Получение ответа от нейросети

**Как** пользователь,  
**я хочу** видеть ответ нейросети после отправки сообщения,  
**чтобы** продолжить диалог.

**Критерии приёмки:**
- [ ] Ответ отображается слева в окне чата
- [ ] Markdown корректно рендерится (заголовки, списки, код, жирный/курсив)
- [ ] Блоки кода имеют подсветку синтаксиса и кнопку "Копировать"
- [ ] Индикатор загрузки исчезает после получения ответа
- [ ] Окно автоматически прокручивается к новому сообщению

---

#### US-2.6: Копирование сообщения ассистента

**Как** пользователь,  
**я хочу** нажать кнопку "Копировать" на сообщении нейросети,  
**чтобы** скопировать текст в буфер обмена.

**Критерии приёмки:**
- [ ] Иконка копирования появляется при наведении на сообщение (desktop) или всегда видна (mobile)
- [ ] При нажатии — текст копируется в буфер обмена
- [ ] Отображается кратковременное подтверждение "Скопировано"
- [ ] Копируется raw-текст (с markdown-разметкой), не HTML

---

#### US-2.7: Регенерация ответа

**Как** пользователь,  
**я хочу** нажать кнопку регенерации на последнем ответе нейросети,  
**чтобы** получить альтернативный ответ.

**Критерии приёмки:**
- [ ] Иконка регенерации отображается только на последнем сообщении ассистента
- [ ] При нажатии — предыдущий ответ заменяется на индикатор загрузки
- [ ] Отправляется повторный запрос с тем же контекстом диалога
- [ ] Новый ответ заменяет предыдущий (не добавляется рядом)
- [ ] История сообщений в БД обновляется

---

#### US-2.8: Отмена запроса

**Как** пользователь,  
**я хочу** нажать кнопку "Отмена" во время ожидания ответа,  
**чтобы** прервать запрос.

**Критерии приёмки:**
- [ ] Кнопка "Отмена" появляется вместо кнопки отправки во время ожидания
- [ ] При нажатии — HTTP-запрос отменяется (AbortController)
- [ ] Индикатор загрузки исчезает
- [ ] Моё сообщение остаётся в чате
- [ ] Сообщение ассистента не создаётся
- [ ] Можно сразу отправить новое сообщение или повторить

---

#### US-2.9: Просмотр существующего чата

**Как** пользователь,  
**я хочу** выбрать чат из истории в боковом меню,  
**чтобы** просмотреть предыдущий диалог и продолжить его.

**Критерии приёмки:**
- [ ] При клике на чат в списке — загружается история сообщений
- [ ] Сообщения отображаются в хронологическом порядке
- [ ] Можно отправить новое сообщение для продолжения диалога
- [ ] Активный чат визуально выделен в боковом меню

---

### Эпик E3: История чатов

---

#### US-3.1: Просмотр списка чатов

**Как** пользователь,  
**я хочу** видеть список своих чатов в боковом меню,  
**чтобы** быстро переключаться между диалогами.

**Критерии приёмки:**
- [ ] Список отображается в левом боковом меню
- [ ] Чаты отсортированы по дате последнего сообщения (новые сверху)
- [ ] Каждый элемент показывает название чата ("Чат №X")
- [ ] Отображается дата/время последнего сообщения
- [ ] Список скроллится, если чатов много
- [ ] Пользователь видит только свои чаты

---

#### US-3.2: Удаление чата

**Как** пользователь,  
**я хочу** удалить ненужный чат,  
**чтобы** поддерживать порядок в истории.

**Критерии приёмки:**
- [ ] Иконка удаления (корзина) появляется при наведении на чат в списке (desktop) или по свайпу/долгому нажатию (mobile)
- [ ] При нажатии — модальное окно подтверждения "Удалить чат? Это действие необратимо"
- [ ] При подтверждении — чат и все его сообщения удаляются из БД
- [ ] Чат исчезает из списка
- [ ] Если удалён активный чат — редирект на главную страницу

---

#### US-3.3: Скрытие/показ бокового меню (mobile)

**Как** пользователь на мобильном устройстве,  
**я хочу** скрывать боковое меню,  
**чтобы** видеть чат на полный экран.

**Критерии приёмки:**
- [ ] На мобильных устройствах меню скрыто по умолчанию
- [ ] Иконка "гамбургер" открывает меню поверх контента
- [ ] Клик вне меню или на элемент чата — закрывает меню
- [ ] На desktop меню всегда видимо

---

### Эпик E4: Профиль пользователя

---

#### US-4.1: Открытие настроек профиля

**Как** пользователь,  
**я хочу** нажать на кнопку профиля,  
**чтобы** открыть настройки.

**Критерии приёмки:**
- [ ] Кнопка профиля расположена в нижней части бокового меню
- [ ] Отображается имя пользователя (или "Пользователь" по умолчанию)
- [ ] При клике открывается модальное окно или выезжающая панель с настройками

---

#### US-4.2: Редактирование имени и фамилии

**Как** пользователь,  
**я хочу** указать своё имя и фамилию в настройках,  
**чтобы** персонализировать профиль.

**Критерии приёмки:**
- [ ] Поля "Имя" и "Фамилия" (текстовые, необязательные)
- [ ] Кнопка "Сохранить"
- [ ] При сохранении — данные обновляются в БД
- [ ] Отображается подтверждение "Изменения сохранены"
- [ ] Имя отображается на кнопке профиля в меню

---

#### US-4.3: Выход из системы (через профиль)

**Как** пользователь,  
**я хочу** нажать кнопку "Выйти" в настройках профиля,  
**чтобы** завершить сеанс.

**Критерии приёмки:**
- [ ] Кнопка "Выйти" в модальном окне профиля
- [ ] См. критерии US-1.2

---

### Эпик E5: Обработка ошибок и очереди

---

#### US-5.1: Уведомление об очереди запросов

**Как** пользователь,  
**я хочу** получить уведомление, если моё сообщение ожидает в очереди,  
**чтобы** понимать, почему ответ задерживается.

**Критерии приёмки:**
- [ ] Если n8n/Ollama возвращает статус "в очереди" (или аналогичный) — отображается toast-уведомление
- [ ] Текст: "Нейросеть обрабатывает другой запрос. Ваше сообщение в очереди..."
- [ ] Уведомление автоматически исчезает, когда начинается обработка
- [ ] Индикатор загрузки продолжает отображаться

**Технические заметки:**
- Требуется определить с бэкендом (n8n), как передаётся статус очереди
- Альтернатива: показывать уведомление при любом ответе дольше N секунд

---

#### US-5.2: Уведомление об ошибке сети/сервера

**Как** пользователь,  
**я хочу** видеть понятное сообщение об ошибке, если что-то пошло не так,  
**чтобы** понимать ситуацию.

**Критерии приёмки:**
- [ ] При ошибке сети — toast "Ошибка соединения. Проверьте интернет и попробуйте снова"
- [ ] При ошибке сервера (5xx) — toast "Сервер временно недоступен. Попробуйте позже"
- [ ] При недоступности Ollama — toast "Нейросеть недоступна. Обратитесь к администратору"
- [ ] В окне чата вместо ответа — сообщение об ошибке с кнопкой "Повторить"

---

#### US-5.3: Таймаут ответа

**Как** пользователь,  
**я хочу** получить уведомление, если ответ не пришёл за 150 секунд,  
**чтобы** не ждать бесконечно.

**Критерии приёмки:**
- [ ] После 150 секунд ожидания запрос отменяется
- [ ] Отображается toast "Превышено время ожидания ответа"
- [ ] В чате появляется сообщение-placeholder с текстом ошибки
- [ ] Отображается кнопка "Повторить" (регенерация)
- [ ] Моё сообщение остаётся в чате

---

## 5. Нефункциональные требования (для контекста)

| Категория | Требование |
|-----------|------------|
| Адаптивность | Полная поддержка desktop (1024px+) и mobile (320px+) |
| Тема | Только светлая |
| Стек (ориентир) | Frontend: React/Next.js, Tailwind CSS, shadcn/ui |
| БД | SQLite/PostgreSQL в контейнере приложения |
| Таймауты | 150 секунд на ответ |
| Сессия | 24 часа, одна активная сессия на пользователя |
| Безопасность | Пользователь видит только свои данные |

---

## 6. Структура БД (концептуально)

```
users
├── id (PK)
├── username (unique)
├── password_hash
├── first_name
├── last_name
├── created_at
└── updated_at

sessions
├── id (PK)
├── user_id (FK → users)
├── token
├── expires_at
└── created_at

chats
├── id (PK)
├── user_id (FK → users)
├── number (порядковый номер для пользователя)
├── title ("Чат №X")
├── created_at
└── updated_at

messages
├── id (PK)
├── chat_id (FK → chats)
├── role (user | assistant)
├── content (text)
└── created_at
```

---

## 7. Интеграция с бэкендом (спецификация)

**Endpoint:** `POST {N8N_WEBHOOK_URL}`

**Headers:**
```
Authorization: Bearer {API_KEY}
Content-Type: application/json
```

**Request body:**
```json
{
  "session_id": "string (chat_id или уникальный идентификатор диалога)",
  "message": "string (текст сообщения пользователя)"
}
```

**Response:**
```json
{
  "response": "string (ответ LLM)"
}
```

**Таймаут:** 150 секунд

---

## 8. Приоритеты реализации (рекомендация)

| Приоритет | User Stories |
|-----------|--------------|
| P0 (MVP) | US-1.1, US-2.1, US-2.3, US-2.4, US-2.5, US-3.1 |
| P1 | US-1.2, US-2.2, US-2.6, US-2.8, US-2.9, US-5.2, US-5.3 |
| P2 | US-2.7, US-3.2, US-4.1, US-4.2, US-5.1 |
| P3 | US-1.3, US-3.3, US-4.3 |

---

Богдан, вот полное ТЗ пользовательских историй. Несколько моментов требуют твоего подтверждения:

1. **Очередь запросов (US-5.1)** — как n8n сообщает, что запрос в очереди? Есть специфичный статус, или нужно определить по времени ответа?

2. **Нумерация чатов** — "Чат №X" — это глобальный счётчик для пользователя (Чат №1, 2, 3...), или можно сбрасывать при удалении?

3. **Формат session_id** — это chat_id из нашей БД, или отдельный идентификатор?